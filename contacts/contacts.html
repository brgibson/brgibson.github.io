<!doctype html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <title>Ben's Experiments - Contacts Widget</title>
        <link rel="stylesheet" href="./contacts.css">
    </head>
    <body>
        <section class="widgetContainer"> <!-- todo - how does the section element degrade in older browsers? -->
            <h1>Contacts</h1> <!-- todo - do I want to use an h1 here? - reference to consider: http://webdesign.tutsplus.com/articles/the-truth-about-multiple-h1-tags-in-the-html5-era--webdesign-16824 -->

            <!-- todo - we will need to associate an image with this user -->

            <ul id="contacts" class="contacts allowHover">
                <!-- todo - include a sample of the final markup here -->    
                <!-- todo - it might be nice to put a placeholder contacts list here, so there isn't a pop in when we load the contacts -->  
            </ul>
            
            <div class="dropdown">
                <select id="defaultDisplay">
                    <option value="email">Email address</option>
                    <option value="phone">Phone number</option>
                </select>
            </div>
        </section>
        
        <script src="./tabularContactData.js"></script> <!-- contains a single string (tabularContactData) containing all of the contacts -->
        <script src="./convertTabularContactData.js"></script> <!-- contains a single function (convertTabularContactData) which takes a string of tabular contact data and returns the markup to be inserted into the "contacts" div -->
        <script src="./buildDefaultDisplayEventHandler.js"></script> <!-- contains a single function (buildDefaultDisplayEventHandler) which returns the event handler for the "defaultDisplay" select list -->
        <script>
            (function() {
                /* add the contacts to the page */
                var contactsContainer = document.getElementById("contacts")
                contactsContainer.innerHTML = convertTabularContactData(tabularContactData);

                /* add a click event handler so that we can support pinning the details open on click for touch devices */ //todo - refactor this out into it's own js file
                (function() {
                    var allowHoverSelector = " allowHover"
                    var pinnedElement = null;
                    var clickEventHandler = function() {
                        if (this.parentNode == pinnedElement) {
                            this.parentNode.className = ""
                            pinnedElement = null;
                            if (contactsContainer.className.indexOf(allowHoverSelector) != 1) {
                                contactsContainer.className += allowHoverSelector;
                            }
                        } else {
                            //clear the styles on the pinned element
                            if (pinnedElement) {
                                pinnedElement.className = "";
                            }
                            //pin the element that was clicked on
                            pinnedElement = this.parentNode;
                            this.parentNode.className = "pinned"

                            contactsContainer.className = contactsContainer.className.replace(allowHoverSelector, "");
                        }
                    };
                    
                    var dtElements = contactsContainer.getElementsByTagName("dt");
                    for (var i = 0; i < dtElements.length; i++) {
                        switch (dtElements[i].getAttribute("data-type")) {
                            case "name": dtElements[i].onclick = clickEventHandler; break;
                        }
                    }
                    
                    //add the event handler to the body, so a user can un-pin a contact by clicking outside of the contact
                    document.body.onclick = clickEventHandler;
                    
                    //stop the event bubble if you are inside the contacts container (so we can still copy past information from the contact details without closing the popup)
                    contactsContainer.onclick = function() {
                        event.stopPropagation();
                        window.event.cancelBubble = true;
                    };
                })();
                
                /* add event handler for email/phone select list */
                //get the email and phone DOM elements
                var emailElements = [],
                    phoneElements = [];
                (function() {
                    var ddElements = contactsContainer.getElementsByTagName("dd");
                    for (var i = 0; i < ddElements.length; i++) {
                        switch (ddElements[i].getAttribute("data-type")) {
                            case "email": emailElements.push(ddElements[i]); break;
                            case "phone": phoneElements.push(ddElements[i]); break;
                        }
                    }
                })();
                
                //attach the event handler
                var defaultDisplyInput = document.getElementById("defaultDisplay");
                defaultDisplyInput.onchange = (function() {
                    var eventHandler = buildDefaultDisplayEventHandler(contactsContainer, emailElements, phoneElements);
                    return function() {
                        eventHandler(defaultDisplyInput.value);
                    };
                })();
                
                /* reorder the email and phone elements, based on the order of the select list */
                defaultDisplyInput.onchange();
            })();
        </script>
        <!-- todo - it might be cool to add a search function -->
    </body>
</html>